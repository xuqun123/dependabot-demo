name: Repo Health Scanner (Claude Code Action)

on:
  schedule:
    - cron: "0 22 * * 0" # Every Monday 8am AEST (9am AEDT)
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  security-events: read
  id-token: write

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Close stale repo-health PRs (idle > 14 days)
        run: |
          gh pr list --label "repo-health" --state open --json number,updatedAt --jq '
            .[] | select(
              (now - (.updatedAt | fromdateiso8601)) > (14 * 24 * 3600)
            ) | .number
          ' | while read -r pr; do
            echo "Closing stale PR #$pr"
            gh pr close "$pr" --comment "Auto-closed: idle for more than 14 days. A new scan will create fresh PRs if issues persist."
          done
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Restore scan cache
        id: cache
        uses: actions/cache@v4
        with:
          path: .repo-health-cache.json
          key: repo-health-scanner-${{ github.repository }}-${{ github.run_id }}
          restore-keys: |
            repo-health-scanner-${{ github.repository }}-

      - uses: anthropics/claude-code-action@v1
        id: scanner
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          show_full_output: true
          prompt: |
            REPO: ${{ github.repository }}

            You are a repo health scanner. Be efficient â€” minimize unnecessary tool calls and file reads.

            ## Scan Cache

            Read `.repo-health-cache.json` if it exists. Use it to:
            - Skip issues that already have open PRs
            - Avoid creating duplicate PRs for the same issue
            After the scan, write an updated cache with: timestamp, findings summary, PRs created, deferred items.

            ## Step 1: Detect Tech Stack

            Run `find . -maxdepth 3 -type f \( -name "package.json" -o -name "requirements.txt" -o -name "pyproject.toml" -o -name "Gemfile" -o -name "go.mod" -o -name "Cargo.toml" -o -name "build.sbt" -o -name "pom.xml" -o -name "build.gradle*" -o -name "Dockerfile" -o -name "docker-compose.yml" -o -name "tsconfig.json" \) 2>/dev/null` to detect the tech stack. Only scan ecosystems that actually exist in this repo.

            ## Step 2: Vulnerability Scan

            - Run `gh api repos/${{ github.repository }}/dependabot/alerts --jq '.[] | select(.state=="open")' 2>/dev/null`
            - Run `gh api repos/${{ github.repository }}/code-scanning/alerts --jq '.[] | select(.state=="open")' 2>/dev/null`
            - Check for: hardcoded secrets, outdated Docker base images, insecure config patterns
            - If API calls fail due to permissions, note it and proceed.

            ## Step 3: Dependency Health Check

            Only for ecosystems detected in Step 1:
            - Check if versions are pinned or use ranges
            - Look for deprecated or EOL runtime versions
            - Verify Dependabot covers these ecosystems in `.github/dependabot.yml`
            - Flag missing lock files

            ## Step 4: Documentation Gap Analysis

            Check for: README.md, getting started guide, testing guide, deployment guide, CONTRIBUTING.md, architecture docs. Evaluate existing docs for staleness.

            ## Step 5: Take Action

            Check existing open PRs first: `gh pr list --label "repo-health" --state open --json title,number`. Do NOT create PRs for issues that already have open PRs.

            Create up to 3 focused draft PRs for NEW findings only:
            1. **Vulnerability / Dependency PR**: Fix dependency issues, Dependabot config gaps, Docker base images
            2. **Documentation PR**: Add missing docs, update outdated references
            3. **Configuration / Hygiene PR**: .gitignore, security scanning config

            For each PR:
            - Branch: `repo-health/<short-description>`
            - Create with: `gh pr create --draft --title "[repo-health] ..." --label "automation,repo-health"`

            If no new actionable findings, create no PRs.

            ## Step 6: Update Cache & Summary

            Write `.repo-health-cache.json` and output a summary with: findings count per category, PR links, deferred items.

          claude_args: |
            --model claude-opus-4-6 --allowedTools "Read,Write,Edit,Bash(gh:*),Bash(git:*),Bash(npm:*),Bash(pip:*),Bash(find:*),Bash(cat:*),Bash(ls:*),Bash(grep:*),Bash(jq:*)"

      - name: Save scan cache
        if: always()
        run: |
          if [ -f .repo-health-cache.json ]; then
            echo "Cache file found, will be saved by actions/cache"
          fi
